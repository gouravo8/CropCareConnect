<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Prices - CropCareConnect</title>

    {# Bootstrap CSS CDN #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    {# Chart.js CDN #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    {# Use Bootstrap's container for proper centering and padding #}
    <div class="container mt-4">
        <h1 class="mb-4 text-center">Current Market Prices (Agmarknet)</h1>

        {# Filter Form - Use Bootstrap classes for layout and styling #}
        <form method="GET" class="row g-3 align-items-end mb-4 p-3 bg-light rounded shadow-sm">
            <div class="col-md-3 col-sm-6">
                <label for="state" class="form-label">State:</label>
                <select name="state" id="state" class="form-select">
                    <option value="">-- Select State --</option>
                    {% for state in unique_states %}
                        <option value="{{ state }}" {% if state == selected_state %}selected{% endif %}>
                            {{ state }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3 col-sm-6">
                <label for="district" class="form-label">District:</label>
                <select name="district" id="district" class="form-select">
                    <option value="">-- Select District --</option>
                    {% for district in unique_districts %}
                        <option value="{{ district }}" {% if district == selected_district %}selected{% endif %}>
                            {{ district }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3 col-sm-6">
                <label for="market" class="form-label">Market:</label>
                <select name="market" id="market" class="form-select">
                    <option value="">-- Select Market --</option>
                    {% for market in unique_markets %}
                        <option value="{{ market }}" {% if market == selected_market %}selected{% endif %}>
                            {{ market }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3 col-sm-6">
                <label for="commodity" class="form-label">Commodity:</label>
                <select name="commodity" id="commodity" class="form-select">
                    <option value="">-- Select Commodity --</option>
                    {% for commodity in unique_commodities %}
                        <option value="{{ commodity }}" {% if commodity == selected_commodity %}selected{% endif %}>
                            {{ commodity }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {# Free-text search input #}
            <div class="col-md-4 col-sm-6">
                <label for="search_query" class="form-label">Search Keywords:</label>
                <input type="text" name="q" id="search_query" value="{{ search_query }}" class="form-control" placeholder="e.g., Tomato, Rajahmundry">
            </div>

            {# Date range inputs #}
            <div class="col-md-3 col-sm-6">
                <label for="start_date" class="form-label">Start Date:</label>
                <input type="date" name="start_date" id="start_date" value="{{ start_date }}" class="form-control">
            </div>

            <div class="col-md-3 col-sm-6">
                <label for="end_date" class="form-label">End Date:</label>
                <input type="date" name="end_date" id="end_date" value="{{ end_date }}" class="form-control">
            </div>

            <div class="col-md-2 col-sm-12 d-grid">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
            </div>
        </form>

        {# NEW: Chart Display Area #}
        {% if chart_labels and chart_data %}
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                Price Trend for {{ chart_commodity }} in {{ chart_market }}, {{ chart_state }}
            </div>
            <div class="card-body">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
        {% elif selected_commodity and selected_market and selected_state %}
        <div class="alert alert-info" role="alert">
            No historical data available for charting for {{ selected_commodity }} in {{ selected_market }}, {{ selected_state }} within the selected filters. Please adjust your filters or fetch more data.
        </div>
        {% else %}
        <div class="alert alert-info" role="alert">
            Filter down to a specific State, Market, and Commodity to see a price trend chart.
        </div>
        {% endif %}


        {# Market Price Table - Use Bootstrap table classes #}
        <div class="table-responsive mb-4"> {# mb-4 adds margin-bottom #}
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>State</th>
                        <th>District</th>
                        <th>Market</th>
                        <th>Commodity</th>
                        <th>Variety</th>
                        <th>Grade</th>
                        <th>Min Price (Rs)</th>
                        <th>Max Price (Rs)</th>
                        <th>Modal Price (Rs)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for price in prices %}
                    <tr>
                        <td>{{ price.arrival_date|date:"d M Y" }}</td>
                        <td>{{ price.state }}</td>
                        <td>{{ price.district }}</td>
                        <td>{{ price.market }}</td>
                        <td>{{ price.commodity }}</td>
                        <td>{{ price.variety }}</td>
                        <td>{{ price.grade }}</td>
                        <td>{{ price.min_price }}</td>
                        <td>{{ price.max_price }}</td>
                        <td>{{ price.modal_price }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center">No market price data available for the selected filters.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# Pagination controls - Use Bootstrap pagination classes #}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if prices.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1&state={{ selected_state }}&district={{ selected_district }}&market={{ selected_market }}&commodity={{ selected_commodity }}&q={{ search_query }}&start_date={{ start_date }}&end_date={{ end_date }}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ prices.previous_page_number }}&state={{ selected_state }}&district={{ selected_district }}&market={{ selected_market }}&commodity={{ selected_commodity }}&q={{ search_query }}&start_date={{ start_date }}&end_date={{ end_date }}">Previous</a>
                    </li>
                {% endif %}

                <li class="page-item active" aria-current="page">
                    <span class="page-link">
                        Page {{ prices.number }} of {{ prices.paginator.num_pages }}
                    </span>
                </li>

                {% if prices.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ prices.next_page_number }}&state={{ selected_state }}&district={{ selected_district }}&market={{ selected_market }}&commodity={{ selected_commodity }}&q={{ search_query }}&start_date={{ start_date }}&end_date={{ end_date }}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ prices.paginator.num_pages }}&state={{ selected_state }}&district={{ selected_district }}&market={{ selected_market }}&commodity={{ selected_commodity }}&q={{ search_query }}&start_date={{ start_date }}&end_date={{ end_date }}">Last</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div> {# Close container div #}

    {# Bootstrap JavaScript CDN #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9Gkcq+pYdCZSmO6a9w+LEwIH" crossorigin="anonymous"></script>

    {# NEW: Chart.js JavaScript for rendering the graph #}
    <script>
        // Get data from Django context
        const chartLabels = JSON.parse('{{ chart_labels|safe }}');
        const chartData = JSON.parse('{{ chart_data|safe }}');
        const chartCommodity = '{{ chart_commodity|safe }}';
        const chartMarket = '{{ chart_market|safe }}';
        const chartState = '{{ chart_state|safe }}';

        if (chartLabels.length > 0 && chartData.length > 0) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: `Modal Price (Rs) of ${chartCommodity} in ${chartMarket}, ${chartState}`,
                        data: chartData,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Price Trend for ${chartCommodity} in ${chartMarket}, ${chartState}`
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Modal Price (Rs)'
                            },
                            beginAtZero: false // Prices don't usually start at zero
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>